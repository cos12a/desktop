import{r as g,q as j,d as O,n as V,c as B,w as $,j as F,f as P,u as l,a as k,g as E,p as T,m as H,F as U,i as A,t as N,x as K,b as W,o as I,_ as z,y as R,s as G}from"./index-CogBM-TU.js";import{u as J}from"./index-CNDZsMhZ.js";function Q(d,y,w){const c=g(""),o=g([]),n=g(-1),r=j(()=>o.value.flatMap(e=>e.commands)),a=g([]),s=g(-1);async function f(){const e=c.value.toLowerCase(),t=await d(e);o.value=t.map(i=>{const v=i.commands.filter(C=>C.cmd.toLowerCase().includes(e)).sort((C,D)=>{const q=C.cmd.toLowerCase().startsWith(e)?0:1,M=D.cmd.toLowerCase().startsWith(e)?0:1;return q-M});return{group:i.group,commands:v}}).filter(i=>i.commands.length>0),n.value=r.value.length>0?0:-1}function h(e){const t=r.value.findIndex(i=>i.cmd===e);t>=0&&(n.value=t)}function p(e){const t=e??r.value[n.value]?.cmd??c.value;t&&(x(t),w(t),c.value="",b())}function b(){o.value=[],n.value=-1}function x(e){a.value.push(e),a.value.length>16&&a.value.shift(),s.value=a.value.length}function S(){o.value.length>0&&n.value>0?n.value--:o.value.length===0&&a.value.length>0&&s.value>0&&(s.value--,c.value=a.value[s.value],y(c.value))}function L(){o.value.length>0&&n.value<r.value.length-1?n.value++:o.value.length===0&&a.value.length>0&&(s.value<a.value.length-1?(s.value++,c.value=a.value[s.value]):(s.value=a.value.length,c.value=""),y(c.value))}function m(){p()}function u(){const e=r.value[n.value]?.cmd;e&&(c.value=e,y(e),b())}return{query:c,groups:o,flatList:r,activeIndex:n,updateSuggestions:f,setActiveByCmd:h,select:p,clear:b,handleUp:S,handleDown:L,handleEnter:m,handleTab:u}}const X={class:"autocomplete"},Y=["placeholder","disabled"],Z={key:0,class:"suggestions"},_=["onClick","onMouseenter"],ee=O({__name:"AutoCompleteInput",props:{placeholder:{},disabled:{type:Boolean},fetcher:{type:Function}},emits:["update:modelValue","enter"],setup(d,{emit:y}){const w=d,c=y,{query:o,groups:n,flatList:r,activeIndex:a,updateSuggestions:s,setActiveByCmd:f,select:h,clear:p,handleUp:b,handleDown:x,handleEnter:S,handleTab:L}=Q(w.fetcher,m=>c("update:modelValue",m),m=>c("enter",m));return V(o,m=>c("update:modelValue",m)),(m,u)=>(I(),B("div",X,[$(k("input",{"onUpdate:modelValue":u[0]||(u[0]=e=>H(o)?o.value=e:null),placeholder:d.placeholder,disabled:d.disabled,onInput:u[1]||(u[1]=(...e)=>l(s)&&l(s)(...e)),onKeydown:[u[2]||(u[2]=E(T((...e)=>l(b)&&l(b)(...e),["prevent"]),["up"])),u[3]||(u[3]=E(T((...e)=>l(x)&&l(x)(...e),["prevent"]),["down"])),u[4]||(u[4]=E(T((...e)=>l(S)&&l(S)(...e),["prevent"]),["enter"])),u[5]||(u[5]=E(T((...e)=>l(L)&&l(L)(...e),["prevent"]),["tab"])),u[6]||(u[6]=E(T((...e)=>l(p)&&l(p)(...e),["prevent"]),["esc"]))],onBlur:u[7]||(u[7]=(...e)=>l(p)&&l(p)(...e))},null,40,Y),[[P,l(o)]]),l(n).length?(I(),B("div",Z,[(I(!0),B(U,null,A(l(n),e=>(I(),B("div",{key:e.group,class:"group"},[k("strong",null,N(e.group),1),k("ul",null,[(I(!0),B(U,null,A(e.commands,(t,i)=>(I(),B("li",{key:t.cmd,class:K({active:l(r)[l(a)]?.cmd===t.cmd}),onClick:v=>l(h)(t.cmd),onMouseenter:v=>l(f)(t.cmd)},[k("code",null,N(t.cmd),1),W(" - "+N(t.desc),1)],42,_))),128))])]))),128))])):F("",!0)]))}}),le=z(ee,[["__scopeId","data-v-679d81c5"]]),te=R("bluetoothConnection",()=>{const{isSupported:d,isConnected:y,device:w,requestDevice:c,server:o}=J({acceptAllDevices:!0,filters:[{namePrefix:"UNITO"}],optionalServices:["0000ffe0-0000-1000-8000-00805f9b34fb","0000ffe1-0000-1000-8000-00805f9b34fb"]});async function n(){await c()}function r(){w.value?.gatt?.disconnect()}return{isSupported:d,isConnected:y,device:w,server:o,connect:n,disconnect:r}}),oe=R("bluetoothShell",()=>{const{server:d,isConnected:y}=G(te()),w="0000ffe1-0000-1000-8000-00805f9b34fb",c="0000ffe2-0000-1000-8000-00805f9b34fb",o=g(!1),n=g([]),r=g(""),a=g([]),s=g(-1);V(y,t=>{t?(p(),console.log("蓝牙已连接，打开 Shell")):(console.log("蓝牙断开，关闭 Shell"),o.value=!1)});let f=null,h=null;async function p(){if(!d.value)return;const i=await(await d.value.getPrimaryService(w)).getCharacteristic(c);f&&h&&(h.removeEventListener("characteristicvaluechanged",f),f=null),i.properties.notify&&(await i.startNotifications(),f=v=>{const C=new Uint8Array(v.target.value.buffer);S(C)},i.addEventListener("characteristicvaluechanged",f),h=i,o.value=!0)}async function b(){try{f&&h&&(h.removeEventListener("characteristicvaluechanged",f),f=null),h&&(await h.stopNotifications().catch(()=>{}),h=null)}catch{}o.value=!1}async function x(t){if(!d.value||!t||!t.trim())return;const v=await(await d.value.getPrimaryService(w)).getCharacteristic(c),C=t+`\r
`,D=new TextEncoder().encode(C);await v.writeValue(D),a.value.push(t),s.value=a.value.length}function S(t){let i="";try{i=new TextDecoder().decode(t)}catch{i="[解码失败]"}const v=new Date().toLocaleTimeString();n.value.unshift(`${v} | ${i.trimEnd()}`),n.value.length>200&&n.value.pop()}function L(){n.value=[]}function m(){const t=new Blob([n.value.join(`
`)],{type:"text/plain;charset=utf-8"}),i=URL.createObjectURL(t),v=document.createElement("a");v.href=i,v.download="ble-shell-log.txt",v.click(),URL.revokeObjectURL(i)}function u(){a.value.length!==0&&s.value>0&&(s.value--,r.value=a.value[s.value])}function e(){a.value.length!==0&&(s.value<a.value.length-1?(s.value++,r.value=a.value[s.value]):(s.value=a.value.length,r.value=""))}return{isShellOpen:o,notifyEntries:n,sendInput:r,openShell:p,closeShell:b,sendData:x,clearNotify:L,saveNotify:m,prevCommand:u,nextCommand:e}});export{le as A,oe as a,te as u};
