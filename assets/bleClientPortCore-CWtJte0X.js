async function d(c,h,f){try{const i=await c.getPrimaryService(h),e=await i.getCharacteristic(f),p=e.properties.notify||e.properties.indicate,a=[],o=[];let s=null,l=null;return p?(l=t=>{const r=t.target.value;if(!r)return;const u=new Uint8Array(r.buffer);if(s=u,a.length>0){const n=a.shift();n&&n(u),s=null}o.forEach(n=>{try{n(u)}catch(w){console.error(w)}})},e.addEventListener("characteristicvaluechanged",l),await e.startNotifications()):console.warn(`特征 ${f} 不支持通知`),{service:i,characteristic:e,async write(t){e.properties.writeWithoutResponse&&typeof e.writeValueWithoutResponse=="function"?await e.writeValueWithoutResponse(t):await e.writeValue(t)},read(t=1e3){return new Promise((r,u)=>{if(s){const n=s;s=null,r(n);return}a.push(r),setTimeout(()=>{const n=a.indexOf(r);n>=0&&a.splice(n,1),u(new Error("读取超时"))},t)})},onNotify(t){if(!p)throw new Error("该特征不支持通知，无法注册回调");return o.push(t),()=>{const r=o.indexOf(t);r>=0&&o.splice(r,1)}},clearLast(){s=null},dispose(){l&&(e.removeEventListener("characteristicvaluechanged",l),e.stopNotifications(),l=null),o.length=0,a.length=0,s=null}}}catch(i){return console.error("❌ 获取服务或特征失败:",i),null}}async function y(c,h,f=1e3){try{return c.clearLast,await c.write(h),{success:!0,response:await c.read(f)}}catch(i){return{success:!1,error:i?.message||String(i)}}}export{d as c,y as s};
