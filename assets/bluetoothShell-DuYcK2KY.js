import{r as g,l as $,d as j,m as D,c as B,w as q,i as F,e as O,u as l,a as T,f as E,z as I,k as z,F as V,h as A,t as U,B as H,b as K,o as k,_ as P,C as W,s as G}from"./index-B27VgFVv.js";import{u as J}from"./bluetoothConnection-BJyjnzJ4.js";function Q(h,w,C){const r=g(""),i=g([]),a=g(-1),c=$(()=>i.value.flatMap(e=>e.commands)),n=g([]),o=g(-1);async function d(){const e=r.value.toLowerCase(),t=await h(e);i.value=t.map(u=>{const v=u.commands.filter(b=>b.cmd.toLowerCase().includes(e)).sort((b,N)=>{const R=b.cmd.toLowerCase().startsWith(e)?0:1,M=N.cmd.toLowerCase().startsWith(e)?0:1;return R-M});return{group:u.group,commands:v}}).filter(u=>u.commands.length>0),a.value=c.value.length>0?0:-1}function f(e){const t=c.value.findIndex(u=>u.cmd===e);t>=0&&(a.value=t)}function p(e){const t=e??c.value[a.value]?.cmd??r.value;t&&(x(t),C(t),r.value="",y())}function y(){i.value=[],a.value=-1}function x(e){n.value.push(e),n.value.length>16&&n.value.shift(),o.value=n.value.length}function L(){i.value.length>0&&a.value>0?a.value--:i.value.length===0&&n.value.length>0&&o.value>0&&(o.value--,r.value=n.value[o.value],w(r.value))}function S(){i.value.length>0&&a.value<c.value.length-1?a.value++:i.value.length===0&&n.value.length>0&&(o.value<n.value.length-1?(o.value++,r.value=n.value[o.value]):(o.value=n.value.length,r.value=""),w(r.value))}function m(){p()}function s(){const e=c.value[a.value]?.cmd;e&&(r.value=e,w(e),y())}return{query:r,groups:i,flatList:c,activeIndex:a,updateSuggestions:d,setActiveByCmd:f,select:p,clear:y,handleUp:L,handleDown:S,handleEnter:m,handleTab:s}}const X={class:"autocomplete"},Y=["placeholder","disabled"],Z={key:0,class:"suggestions"},_=["onClick","onMouseenter"],ee=j({__name:"AutoCompleteInput",props:{placeholder:{},disabled:{type:Boolean},fetcher:{type:Function}},emits:["update:modelValue","enter"],setup(h,{emit:w}){const C=h,r=w,{query:i,groups:a,flatList:c,activeIndex:n,updateSuggestions:o,setActiveByCmd:d,select:f,clear:p,handleUp:y,handleDown:x,handleEnter:L,handleTab:S}=Q(C.fetcher,m=>r("update:modelValue",m),m=>r("enter",m));return D(i,m=>r("update:modelValue",m)),(m,s)=>(k(),B("div",X,[q(T("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>z(i)?i.value=e:null),placeholder:h.placeholder,disabled:h.disabled,onInput:s[1]||(s[1]=(...e)=>l(o)&&l(o)(...e)),onKeydown:[s[2]||(s[2]=E(I((...e)=>l(y)&&l(y)(...e),["prevent"]),["up"])),s[3]||(s[3]=E(I((...e)=>l(x)&&l(x)(...e),["prevent"]),["down"])),s[4]||(s[4]=E(I((...e)=>l(L)&&l(L)(...e),["prevent"]),["enter"])),s[5]||(s[5]=E(I((...e)=>l(S)&&l(S)(...e),["prevent"]),["tab"])),s[6]||(s[6]=E(I((...e)=>l(p)&&l(p)(...e),["prevent"]),["esc"]))],onBlur:s[7]||(s[7]=(...e)=>l(p)&&l(p)(...e))},null,40,Y),[[O,l(i)]]),l(a).length?(k(),B("div",Z,[(k(!0),B(V,null,A(l(a),e=>(k(),B("div",{key:e.group,class:"group"},[T("strong",null,U(e.group),1),T("ul",null,[(k(!0),B(V,null,A(e.commands,(t,u)=>(k(),B("li",{key:t.cmd,class:H({active:l(c)[l(n)]?.cmd===t.cmd}),onClick:v=>l(f)(t.cmd),onMouseenter:v=>l(d)(t.cmd)},[T("code",null,U(t.cmd),1),K(" - "+U(t.desc),1)],42,_))),128))])]))),128))])):F("",!0)]))}}),le=P(ee,[["__scopeId","data-v-679d81c5"]]),ae=W("bluetoothShell",()=>{const{server:h,isConnected:w}=G(J()),C="0000ffe1-0000-1000-8000-00805f9b34fb",r="0000ffe2-0000-1000-8000-00805f9b34fb",i=g(!1),a=g([]),c=g(""),n=g([]),o=g(-1);D(w,t=>{t?(p(),console.log("蓝牙已连接，打开 Shell")):(console.log("蓝牙断开，关闭 Shell"),i.value=!1)});let d=null,f=null;async function p(){if(!h.value)return;const u=await(await h.value.getPrimaryService(C)).getCharacteristic(r);d&&f&&(f.removeEventListener("characteristicvaluechanged",d),d=null),u.properties.notify&&(await u.startNotifications(),d=v=>{const b=new Uint8Array(v.target.value.buffer);L(b)},u.addEventListener("characteristicvaluechanged",d),f=u,i.value=!0)}async function y(){try{d&&f&&(f.removeEventListener("characteristicvaluechanged",d),d=null),f&&(await f.stopNotifications().catch(()=>{}),f=null)}catch{}i.value=!1}async function x(t){if(!h.value||!t||!t.trim())return;const v=await(await h.value.getPrimaryService(C)).getCharacteristic(r),b=t+`\r
`,N=new TextEncoder().encode(b);await v.writeValue(N),n.value.push(t),o.value=n.value.length}function L(t){let u="";try{u=new TextDecoder().decode(t)}catch{u="[解码失败]"}const v=new Date().toLocaleTimeString();a.value.unshift(`${v} | ${u.trimEnd()}`),a.value.length>200&&a.value.pop()}function S(){a.value=[]}function m(){const t=new Blob([a.value.join(`
`)],{type:"text/plain;charset=utf-8"}),u=URL.createObjectURL(t),v=document.createElement("a");v.href=u,v.download="ble-shell-log.txt",v.click(),URL.revokeObjectURL(u)}function s(){n.value.length!==0&&o.value>0&&(o.value--,c.value=n.value[o.value])}function e(){n.value.length!==0&&(o.value<n.value.length-1?(o.value++,c.value=n.value[o.value]):(o.value=n.value.length,c.value=""))}return{isShellOpen:i,notifyEntries:a,sendInput:c,openShell:p,closeShell:y,sendData:x,clearNotify:S,saveNotify:m,prevCommand:s,nextCommand:e}});export{le as A,ae as u};
