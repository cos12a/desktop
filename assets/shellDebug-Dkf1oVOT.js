import{d as R,r as p,n as V,c as b,a as n,u,t as x,b as A,w as $,f as M,g as m,p as S,o as _,_ as q}from"./index-D3lqa7Eb.js";import{u as H}from"./index-D0FcuMVo.js";const J={class:"page"},W={class:"controls"},z=["disabled"],F=["disabled"],G={key:0},Q={key:1},X={class:"controls"},Y=["disabled"],Z=["disabled"],ee=["disabled"],te={key:0},ne={key:1},oe={class:"log"},ae={class:"controls"},se=["onKeydown","disabled"],le=["disabled"],D="0000ffe1-0000-1000-8000-00805f9b34fb",w="0000ffe2-0000-1000-8000-00805f9b34fb",ce=R({__name:"shellDebug",setup(ie){const{isSupported:L,isConnected:d,device:y,requestDevice:N,server:v}=H({acceptAllDevices:!0,filters:[{namePrefix:"UNITO"}],optionalServices:["0000ffe0-0000-1000-8000-00805f9b34fb","0000ffe1-0000-1000-8000-00805f9b34fb"]}),a=p(""),f=p([]),s=p(!1),U=p();let l=null,c=null;async function E(){try{await N(),console.log("手动连接蓝牙设备，连接成功！")}catch(t){console.error("蓝牙连失败:",t)}}V(d,t=>{t?(console.log("监听蓝牙设备连接连接成功！"),C()):(console.log("监听蓝牙设备连接断开"),g())});function B(){y.value?.gatt?.connected&&(y.value.gatt.disconnect(),s.value=!1,g())}async function T(){if(!v.value){alert("❌ 设备未连接");return}try{const t=await v.value.getPrimaryServices();for(const e of t){console.log("🔹 Service:",e.uuid);const o=await e.getCharacteristics();for(const h of o)console.log("   ↳ Characteristic:",h.uuid,"Properties:",JSON.stringify(h.properties))}}catch(t){console.error("扫描服务/特征失败:",t),alert("❌ 扫描服务/特征失败")}}async function C(){if(v.value)try{const e=await(await v.value.getPrimaryService(D)).getCharacteristic(w);l&&c&&(c.removeEventListener("characteristicvaluechanged",l),l=null),e.properties.notify?(await e.startNotifications(),l=o=>{const h=new Uint8Array(o.target.value.buffer);O(h)},e.addEventListener("characteristicvaluechanged",l),c=e,s.value=!0):alert("❌ 当前特征不支持通知")}catch(t){console.error("获取特征失败:",t),alert(`❌ 无法找到特征 ${w}，请检查设备支持的服务/特征`)}}async function g(){try{l&&c&&(c.removeEventListener("characteristicvaluechanged",l),l=null),c&&(await c.stopNotifications().catch(()=>{console.warn("通知已停止或设备已断开")}),c=null)}catch(t){console.error("关闭 Shell 出错:",t)}s.value=!1}async function k(){if(!v.value||!a.value)return;const e=await(await v.value.getPrimaryService(D)).getCharacteristic(w),o=a.value+`\r
`,h=new TextEncoder().encode(o);await e.writeValue(h),i.value.push(a.value),r.value=i.value.length,a.value=""}function O(t){let e="";try{e=new TextDecoder().decode(t)}catch{e="[解码失败]"}const o=new Date().toLocaleTimeString();f.value.unshift(`${o} | ${e.trimEnd()}`),f.value.length>200&&f.value.pop()}function P(){f.value=[]}function j(){const t=new Blob([f.value.join(`
`)],{type:"text/plain;charset=utf-8"}),e=URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download="ble-shell-log.txt",o.click(),URL.revokeObjectURL(e)}const i=p([]),r=p(-1);function I(){i.value.length!==0&&r.value>0&&(r.value--,a.value=i.value[r.value])}function K(){i.value.length!==0&&(r.value<i.value.length-1?(r.value++,a.value=i.value[r.value]):(r.value=i.value.length,a.value=""))}return(t,e)=>(_(),b("section",J,[e[2]||(e[2]=n("h1",null,"Web 蓝牙 Shell 调试",-1)),n("div",W,[n("button",{onClick:E,disabled:!u(L)||u(d)},"连接",8,z),n("button",{onClick:B,disabled:!u(d)},"断开",8,F),u(d)?(_(),b("span",G,"✅ 已连接: "+x(u(y)?.name||"未知设备"),1)):(_(),b("span",Q,"❌ 未连接"))]),n("div",X,[n("button",{onClick:C,disabled:!u(d)||s.value},"打开 Shell 调试",8,Y),n("button",{onClick:g,disabled:!s.value},"关闭 Shell 调试",8,Z),n("button",{onClick:T,disabled:!u(d)}," 扫描服务/特征 ",8,ee),s.value?(_(),b("span",te,"📡 Shell 调试已打开")):(_(),b("span",ne,"未打开"))]),n("div",oe,[n("h3",null,[e[1]||(e[1]=A(" 接收数据 ",-1)),n("button",{onClick:P},"清除"),n("button",{onClick:j},"保存")]),n("pre",{ref_key:"recvBox",ref:U,class:"recv-box"},""+x(f.value.join(`
`))+`
      `,513)]),n("div",ae,[$(n("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>a.value=o),placeholder:"输入命令后回车发送",onKeyup:m(k,["enter"]),onKeydown:[m(S(I,["prevent"]),["up"]),m(S(K,["prevent"]),["down"])],disabled:!s.value},null,40,se),[[M,a.value]]),n("button",{onClick:k,disabled:!s.value||!a.value},"发送",8,le)])]))}}),de=q(ce,[["__scopeId","data-v-4366f9db"]]);export{de as default};
